<IfModule mod_rewrite.c>
  RewriteEngine On

  # Serviere Brotli, wenn vorhanden und vom Browser unterstützt
  RewriteCond %{HTTP:Accept-Encoding} br
  RewriteCond %{REQUEST_FILENAME}.br -f
  RewriteRule ^(.*)\.(js|css|html|svg)$ $1.$2.br [L]

  # Serviere Gzip als Fallback
  RewriteCond %{HTTP:Accept-Encoding} gzip
  RewriteCond %{REQUEST_FILENAME}.gz -f
  RewriteRule ^(.*)\.(js|css|html|svg)$ $1.$2.gz [L]

  # Setze die korrekten Header, damit der Browser weiß, was er da hat
  AddType text/javascript .js.br
  AddType application/javascript .js.br
  AddType application/json .json.br
  AddType image/svg+xml .svg.br
  AddType text/html .html.br
  AddType text/css .css.br
  AddEncoding br .br

  AddType text/javascript .js.gz
  AddType application/javascript .js.gz
  AddType application/json .json.gz
  AddType image/svg+xml .svg.gz
  AddType text/html .html.gz
  AddType text/css .css.gz
  AddEncoding gzip .gz

  <FilesMatch "\.js\.br$">
    ForceType application/javascript
  </FilesMatch>
  <FilesMatch "\.css\.br$">
    ForceType text/css
  </FilesMatch>
  <FilesMatch "\.svg\.br$">
    ForceType image/svg+xml
  </FilesMatch>

  RewriteBase /

  # 1. Ausnahme: API-Aufrufe direkt durchlassen
  RewriteRule ^api/ - [L]

  # 2. Spezialfall: Absolute Hauptdomain auf /app/ umleiten
  # Das muss VOR der Prüfung auf existierende Verzeichnisse stehen!
  RewriteRule ^$ /app/ [R=301,L]

  # 3. Wenn die angeforderte DATEI existiert (js, css, bilder), direkt ausliefern
  # WICHTIG: Die Prüfung auf Verzeichnisse (-d) haben wir hier entfernt,
  # damit /app nicht als Ordner erkannt wird und abbricht.
  RewriteCond %{REQUEST_FILENAME} -f
  RewriteRule ^ - [L]

  # 4. Wenn der Pfad NICHT mit /app anfängt, /app/ davorhängen (z.B. /login)
  RewriteCond %{REQUEST_URI} !^/app($|/)
  RewriteRule ^(.*)$ /app/$1 [R=301,L]

  # 5. Vue.js History Mode:
  # Alle Aufrufe, die jetzt mit /app beginnen, laden die index.html
  RewriteRule ^app($|/) index.html [L]
</IfModule>
